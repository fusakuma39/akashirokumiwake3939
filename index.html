<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹å‹•ä¼š çµ„ã¿åˆ†ã‘ãƒã‚¹ã‚¿ãƒ¼</title>
    <!-- React & Tailwind CSS -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Excelå‡ºåŠ›ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f0fdf4; color: #1e293b; }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        .custom-scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f0fdf4; border-radius: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #86efac; border-radius: 5px; border: 2px solid #f0fdf4; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4ade80; }

        /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è¨­å®š */
        textarea.data-input {
            font-family: "MS Gothic", "Hiragino Kaku Gothic ProN", monospace;
            tab-size: 12;
            white-space: pre;
            line-height: 1.6;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (SVG) ---
        const Icons = {
            Grade: () => <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
            Class: () => <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>,
            Separate: () => <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
            Mixed: () => <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Time: () => <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Height: () => <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>,
            Check: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            ArrowRight: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>,
            ArrowLeft: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
            Download: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            Settings: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Sort: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg>,
            User: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
            Run: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Info: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Shield: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
        };

        // --- å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: é¸æŠã‚«ãƒ¼ãƒ‰ (Green Theme) ---
        const SelectionCard = ({ selected, onClick, icon: Icon, title, desc, color = "green" }) => {
            const baseClass = "cursor-pointer rounded-xl border-2 p-4 flex flex-col items-center gap-3 transition-all duration-200 w-full";
            const activeClass = selected 
                ? `border-${color}-500 bg-${color}-50 text-${color}-700 shadow-md transform scale-[1.02]` 
                : "border-slate-200 bg-white text-slate-500 hover:border-slate-300 hover:bg-slate-50";
            
            return (
                <div onClick={onClick} className={`${baseClass} ${activeClass}`}>
                    <div className={selected ? `text-${color}-600` : "text-slate-400"}>
                        <Icon />
                    </div>
                    <div className="text-center">
                        <div className="font-bold text-lg leading-tight">{title}</div>
                        {desc && <div className="text-xs mt-1 opacity-80">{desc}</div>}
                    </div>
                    {selected && <div className={`absolute top-2 right-2 text-${color}-500`}><Icons.Check /></div>}
                </div>
            );
        };

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«
        const PasswordModal = ({ show, onClose, onSuccess }) => {
            const [inputVal, setInputVal] = useState('');
            const [error, setError] = useState('');
            const inputRef = useRef(null);

            useEffect(() => {
                if (show && inputRef.current) {
                    inputRef.current.focus();
                }
            }, [show]);

            if (!show) return null;

            const handleExecute = () => {
                if (inputVal === SECRET_KEY) {
                    onSuccess();
                } else {
                    setError('åˆè¨€è‘‰ãŒé•ã„ã¾ã™');
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') handleExecute();
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.Shield/> åˆè¨€è‘‰</h3>
                        <p className="text-sm text-slate-600 mb-4">åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                        <input ref={inputRef} type="text" className="w-full border-2 border-slate-200 rounded-lg p-3 mb-2 focus:border-green-500 focus:outline-none" placeholder="åˆè¨€è‘‰" value={inputVal} onChange={(e) => setInputVal(e.target.value)} onKeyDown={handleKeyDown} />
                        {error && <p className="text-red-500 text-xs font-bold mb-4">{error}</p>}
                        <div className="flex justify-end gap-3 mt-4">
                            <button onClick={onClose} className="text-slate-500 font-bold px-4 py-2 hover:bg-slate-100 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onClick={handleExecute} className="bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-2 rounded-lg shadow-md">å®Ÿè¡Œ</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- å®šæ•°ãƒ»ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ ---
        const PATTERNS = [
            { id: 'abba', name: 'èµ¤ ç™½ ç™½ èµ¤', sub: 'ã‚¸ã‚°ã‚¶ã‚°ãƒ»èµ¤å§‹', desc: '1ä½:èµ¤, 2ä½:ç™½, 3ä½:ç™½, 4ä½:èµ¤...' },
            { id: 'baab', name: 'ç™½ èµ¤ èµ¤ ç™½', sub: 'ã‚¸ã‚°ã‚¶ã‚°ãƒ»ç™½å§‹', desc: '1ä½:ç™½, 2ä½:èµ¤, 3ä½:èµ¤, 4ä½:ç™½...' },
            { id: 'abab', name: 'èµ¤ ç™½ èµ¤ ç™½', sub: 'é †é€ã‚Šãƒ»èµ¤å§‹', desc: '1ä½:èµ¤, 2ä½:ç™½, 3ä½:èµ¤, 4ä½:ç™½...' },
            { id: 'baba', name: 'ç™½ èµ¤ ç™½ èµ¤', sub: 'é †é€ã‚Šãƒ»ç™½å§‹', desc: '1ä½:ç™½, 2ä½:èµ¤, 3ä½:ç™½, 4ä½:èµ¤...' },
        ];

        const SAMPLE_DATA = `ä½è—¤å¤ªéƒ	1	ç”·	8.5	142.5	
éˆ´æœ¨ä¸€éƒ	1	ç”·	7.8	145.0	
é«˜æ©‹å¥å¤ª	1	ç”·	9.1	138.5	
ç”°ä¸­å¤§è¼”	1	ç”·	8.3	140.0	
ä¼Šè—¤ç¿”	1	ç”·	7.5	148.0	èµ¤
æ¸¡è¾ºæ‹“æµ·	1	ç”·	8.9	135.5	
å±±æœ¬æ¶¼å¤ª	1	ç”·	9.5	132.0	
ä¸­æ‘é™¸	1	ç”·	8.0	144.5	
å°æ—è“®	1	ç”·	8.6	139.0	
åŠ è—¤é™½å‘	1	ç”·	9.0	136.0	
ä½è—¤èŠ±å­	1	å¥³	9.2	135.0	
éˆ´æœ¨æ„›	1	å¥³	8.8	140.5	
é«˜æ©‹çµè¡£	1	å¥³	9.5	130.0	
ç”°ä¸­ç¾å’²	1	å¥³	8.5	142.0	
ä¼Šè—¤è‘µ	1	å¥³	8.0	146.0	
æ¸¡è¾ºå‡›	1	å¥³	9.8	128.5	
å±±æœ¬ã•ãã‚‰	1	å¥³	9.0	138.0	ç™½
ä¸­æ‘å„ªå¥ˆ	1	å¥³	8.7	141.5	
å°æ—é™½èœ	1	å¥³	9.3	133.0	
åŠ è—¤ç¾å„ª	1	å¥³	8.9	139.5	
å‰ç”°å¤§è¼	2	ç”·	8.2	141.0	
å±±ç”°è’¼å¤§	2	ç”·	7.9	146.5	
ä½ã€…æœ¨ç‘›å¤ª	2	ç”·	8.8	137.0	
å±±å£æ¨¹	2	ç”·	8.4	143.0	
æ¾æœ¬æ¹Š	2	ç”·	7.6	149.0	
äº•ä¸Šæ‚ çœŸ	2	ç”·	9.2	134.5	
æœ¨æ‘æœé™½	2	ç”·	9.4	131.0	
æ—å¤§ç¿”	2	ç”·	8.1	145.0	
æ–è—¤æ–°	2	ç”·	8.7	138.0	
æ¸…æ°´é¢¯å¤ª	2	ç”·	9.1	135.5	
å‰ç”°çµèœ	2	å¥³	9.1	136.0	
å±±ç”°è‰å­	2	å¥³	8.6	143.0	
ä½ã€…æœ¨èŠ½ä¾	2	å¥³	9.4	131.5	
å±±å£å¿ƒæ˜¥	2	å¥³	8.4	144.0	
æ¾æœ¬ç¾æœˆ	2	å¥³	8.1	147.5	
äº•ä¸Šå¿ƒå„ª	2	å¥³	9.7	129.0	
æœ¨æ‘æ„›è‰	2	å¥³	8.9	139.0	
æ—æå¥ˆ	2	å¥³	8.8	140.0	
æ–è—¤æ¾ª	2	å¥³	9.3	134.0	
æ¸…æ°´å½©è‘‰	2	å¥³	9.0	137.5	`;

        /* åˆè¨€è‘‰è¦‹ã¤ã‹ã£ã¡ã‚ƒã£ãŸï¼é™å‚ï¼ã”è‡ªç”±ã«ãŠä½¿ã„ãã ã•ã„ã€‚ */
        const SECRET_KEY = "ã‚¦ãƒ³ãƒ‰ã‚¦ã‚«ã‚¤";

        const App = () => {
            const [step, setStep] = useState(1);
            
            // Step 1: åŸºæœ¬æ¡ä»¶
            const [grouping, setGrouping] = useState('grade'); 
            const [mode, setMode] = useState('separate'); 
            const [criteria, setCriteria] = useState('time'); 
            
            // Step 2: ãƒ«ãƒ¼ãƒ«
            const [ruleBoy, setRuleBoy] = useState('abba');
            const [ruleGirl, setRuleGirl] = useState('baab');

            // Step 3: ãƒ‡ãƒ¼ã‚¿
            const [rawInput, setRawInput] = useState('');
            const [teamData, setTeamData] = useState([]); 
            const [showPasswordModal, setShowPasswordModal] = useState(false);

            // Step 5: å‡ºåŠ›è¨­å®š
            const [raceEnabled, setRaceEnabled] = useState(true);
            const [raceMode, setRaceMode] = useState('separate');
            const [runnersPerRace, setRunnersPerRace] = useState(5);
            
            const [lineupEnabled, setLineupEnabled] = useState(true);
            const [lineupGrouping, setLineupGrouping] = useState('class');
            const [lineupMode, setLineupMode] = useState('separate');
            const [lineupColumns, setLineupColumns] = useState(2);

            // Step 6: æœ€çµ‚ãƒ‡ãƒ¼ã‚¿
            const [raceList, setRaceList] = useState([]);
            const [lineupList, setLineupList] = useState([]);

            useEffect(() => { window.scrollTo(0, 0); }, [step]);

            // --- Logic ---
            const downloadTemplate = () => {
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const header = "æ°å,ã‚¯ãƒ©ã‚¹,æ€§åˆ¥,ã‚¿ã‚¤ãƒ ,èº«é•·,ãƒãƒ¼ãƒ æŒ‡å®š(ä»»æ„)\n";
                const row1 = "ä½è—¤å¤ªéƒ,1,ç”·,8.5,140.5,\n";
                const row2 = "éˆ´æœ¨èŠ±å­,1,å¥³,9.2,138.0,èµ¤\n";
                const blob = new Blob([bom, header + row1 + row2], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "çµ„ã¿åˆ†ã‘å…¥åŠ›ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.csv";
                a.click();
                URL.revokeObjectURL(url);
            };

            const parseData = (input) => {
                if (!input) return [];
                const lines = input.trim().split(/\r?\n/);
                return lines.map((line, idx) => {
                    if (!line.trim()) return null;
                    let parts = line.split(/[\t,]+/);
                    if (parts.length < 2 && line.includes(' ')) parts = line.split(/\s+/);
                    parts = parts.map(p => p.trim());
                    if (parts.length < 2) return null;
                    return {
                        id: idx,
                        name: parts[0] || '',
                        classNum: parts[1] || '1',
                        gender: parts[2] || 'ä¸æ˜',
                        time: parseFloat(parts[3]) || 99.99,
                        height: parseFloat(parts[4]) || 0,
                        fixedTeam: parts[5] || '',
                    };
                }).filter(d => d !== null);
            };

            const requestAssignTeams = () => {
                const students = parseData(rawInput);
                if (students.length === 0) { alert('ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
                setShowPasswordModal(true);
            };

            const onPasswordSuccess = () => {
                setShowPasswordModal(false);
                assignTeams();
            };

            const assignTeams = () => {
                const students = parseData(rawInput);
                const getSorter = () => criteria === 'time' ? (a, b) => a.time - b.time : (a, b) => a.height - b.height;

                const applyPattern = (list, patternType) => {
                    const sortedList = [...list].sort(getSorter());
                    let patternCounter = 0;

                    sortedList.forEach((student, index) => {
                        if (student.fixedTeam && student.fixedTeam.trim() !== '') {
                            student.team = student.fixedTeam.trim();
                            student.isFixed = true;
                        } else {
                            let autoTeam = '';
                            const mod4 = patternCounter % 4;
                            const mod2 = patternCounter % 2;
                            switch (patternType) {
                                case 'abba': autoTeam = (mod4 === 0 || mod4 === 3) ? 'èµ¤' : 'ç™½'; break;
                                case 'baab': autoTeam = (mod4 === 0 || mod4 === 3) ? 'ç™½' : 'èµ¤'; break;
                                case 'abab': autoTeam = (mod2 === 0) ? 'èµ¤' : 'ç™½'; break;
                                case 'baba': autoTeam = (mod2 === 0) ? 'ç™½' : 'èµ¤'; break;
                            }
                            student.team = autoTeam;
                            student.isFixed = false;
                            patternCounter++;
                        }
                        student.rankInGroup = index + 1;
                    });
                    return sortedList;
                };

                const processGroup = (groupList) => {
                    if (mode === 'separate') {
                        const boys = groupList.filter(s => /ç”·|M|boy/i.test(s.gender));
                        const girls = groupList.filter(s => !boys.includes(s));
                        return [...applyPattern(boys, ruleBoy), ...applyPattern(girls, ruleGirl)];
                    } else {
                        return applyPattern(groupList, ruleBoy);
                    }
                };

                let processed = [];
                if (grouping === 'class') {
                    const classes = [...new Set(students.map(s => s.classNum))].sort();
                    classes.forEach(cls => {
                        const members = students.filter(s => s.classNum === cls);
                        processed = [...processed, ...processGroup(members)];
                    });
                } else {
                    processed = processGroup(students);
                }
                
                setTeamData(processed);
                setStep(4);
            };

            const generateFinalOutput = () => {
                let races = [];
                if (raceEnabled) {
                    const groups = [];
                    if (raceMode === 'separate') {
                        groups.push({ name: 'ç”·å­', list: teamData.filter(s => /ç”·|M/i.test(s.gender)) });
                        groups.push({ name: 'å¥³å­', list: teamData.filter(s => !/ç”·|M/i.test(s.gender)) });
                    } else {
                        groups.push({ name: 'æ··åˆ', list: teamData });
                    }

                    groups.forEach(group => {
                        const sorted = [...group.list].sort((a, b) => a.time - b.time);
                        let reds = sorted.filter(s => s.team === 'èµ¤');
                        let whites = sorted.filter(s => s.team === 'ç™½');
                        let raceCount = 1;
                        
                        while (reds.length > 0 || whites.length > 0) {
                            const needed = runnersPerRace;
                            const isOddRace = (raceCount % 2 !== 0);
                            let redTarget = isOddRace ? Math.ceil(needed / 2) : Math.floor(needed / 2);
                            let whiteTarget = isOddRace ? Math.floor(needed / 2) : Math.ceil(needed / 2);

                            let rTake = reds.splice(0, redTarget);
                            let wTake = whites.splice(0, whiteTarget);
                            
                            if (rTake.length + wTake.length < needed) {
                                const shortage = needed - (rTake.length + wTake.length);
                                if (reds.length > 0) rTake = rTake.concat(reds.splice(0, shortage));
                                else if (whites.length > 0) wTake = wTake.concat(whites.splice(0, shortage));
                            }

                            const laneMembers = [];
                            const max = rTake.length + wTake.length;
                            for (let i = 0; i < max; i++) {
                                let member;
                                if (isOddRace) {
                                    if (i % 2 === 0) member = rTake.length ? rTake.shift() : wTake.shift();
                                    else member = wTake.length ? wTake.shift() : rTake.shift();
                                } else {
                                    if (i % 2 === 0) member = wTake.length ? wTake.shift() : rTake.shift();
                                    else member = rTake.length ? rTake.shift() : wTake.shift();
                                }
                                if (member) laneMembers.push(member);
                            }

                            laneMembers.forEach((m, idx) => {
                                races.push({
                                    group: group.name,
                                    raceNo: raceCount,
                                    lane: idx + 1,
                                    ...m
                                });
                            });
                            raceCount++;
                        }
                    });
                }
                setRaceList(races);

                let lineups = [];
                if (lineupEnabled) {
                    const sortFunc = (a, b) => {
                        if (lineupGrouping === 'class' && a.classNum !== b.classNum) return a.classNum - b.classNum;
                        if (lineupMode === 'separate') {
                            const aIsBoy = /ç”·|M/i.test(a.gender);
                            const bIsBoy = /ç”·|M/i.test(b.gender);
                            if (aIsBoy !== bIsBoy) return aIsBoy ? -1 : 1;
                        }
                        if (a.team !== b.team) return a.team === 'èµ¤' ? -1 : 1;
                        const aIsBoy = /ç”·|M/i.test(a.gender);
                        const bIsBoy = /ç”·|M/i.test(b.gender);
                        if (aIsBoy !== bIsBoy) return aIsBoy ? -1 : 1;
                        return a.height - b.height;
                    };

                    const sortedRaw = [...teamData].sort(sortFunc);
                    
                    const grouped = {};
                    sortedRaw.forEach(s => {
                        let key = s.team; 
                        if (lineupGrouping === 'class') key += `_${s.classNum}çµ„`;
                        else key += `_å…¨ä½“`; 
                        
                        if (!grouped[key]) grouped[key] = [];
                        grouped[key].push(s);
                    });

                    Object.keys(grouped).forEach(key => {
                        const members = grouped[key];
                        const groupName = key.replace('_', ' ');

                        if (lineupMode === 'separate') {
                            const boysCols = Math.floor(lineupColumns / 2) || 1;
                            const girlsCols = lineupColumns - boysCols || 1;
                            const boys = members.filter(s => /ç”·|M/i.test(s.gender));
                            const girls = members.filter(s => !/ç”·|M/i.test(s.gender));

                            let bCount = 0;
                            boys.forEach(s => {
                                s.groupKey = groupName;
                                s.column = (bCount % boysCols) + 1; 
                                s.row = Math.floor(bCount / boysCols) + 1;
                                lineups.push(s);
                                bCount++;
                            });

                            let gCount = 0;
                            girls.forEach(s => {
                                s.groupKey = groupName;
                                s.column = (gCount % girlsCols) + 1 + boysCols; 
                                s.row = Math.floor(gCount / girlsCols) + 1;
                                lineups.push(s);
                                gCount++;
                            });

                        } else {
                            members.forEach((s, i) => {
                                s.groupKey = groupName;
                                s.column = (i % lineupColumns) + 1;
                                s.row = Math.floor(i / lineupColumns) + 1;
                                lineups.push(s);
                            });
                        }
                    });
                }
                setLineupList(lineups);
                setStep(6);
            };

            // --- UI Components ---
            const PreviewTable = ({ inputData }) => {
                const parsed = parseData(inputData);
                if (parsed.length === 0) return null;
                return (
                    <div className="mt-4 bg-white rounded-lg border border-green-200 overflow-hidden text-sm animate-fade-in">
                        <div className="bg-green-50 p-3 text-green-800 font-bold border-b border-green-200 flex items-center gap-2">
                            <Icons.Check /> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (å…¨{parsed.length}å)
                        </div>
                        <div className="max-h-96 overflow-y-auto custom-scrollbar">
                            <table className="w-full text-left">
                                <thead className="bg-green-50 sticky top-0 text-xs text-green-700 uppercase">
                                    <tr><th className="p-2 pl-4">æ°å</th><th className="p-2">ã‚¯ãƒ©ã‚¹</th><th className="p-2">æ€§åˆ¥</th><th className="p-2">ã‚¿ã‚¤ãƒ </th><th className="p-2">èº«é•·</th><th className="p-2 text-red-600">æŒ‡å®š</th></tr>
                                </thead>
                                <tbody>
                                    {parsed.map((r, i) => (
                                        <tr key={i} className="border-b bg-white hover:bg-green-50">
                                            <td className="p-2 pl-4 font-bold">{r.name}</td>
                                            <td className="p-2">{r.classNum}</td>
                                            <td className="p-2">{r.gender}</td>
                                            <td className="p-2 font-mono">{r.time}</td>
                                            <td className="p-2 font-mono">{r.height}</td>
                                            <td className="p-2 text-red-600 font-bold">{r.fixedTeam}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const ResultTableStep4 = () => {
                const downloadRoster = () => {
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(teamData.map(d => ({
                        "ã‚¯ãƒ©ã‚¹": d.classNum, "ãƒãƒ¼ãƒ ": d.team, "æ°å": d.name, "æ€§åˆ¥": d.gender, "ã‚¿ã‚¤ãƒ ": d.time, "èº«é•·": d.height, "é †ä½": d.rankInGroup
                    })));
                    XLSX.utils.book_append_sheet(wb, ws, "åç°¿ä¸€è¦§");
                    XLSX.writeFile(wb, "é‹å‹•ä¼š_åç°¿ä¸€è¦§.xlsx");
                };

                return (
                    <div className="bg-white rounded-xl shadow-sm border border-green-200 overflow-hidden">
                        <div className="p-4 bg-green-50 border-b border-green-200 flex justify-between items-center">
                            <h3 className="font-bold text-green-800 flex items-center gap-2"><Icons.User/> æŒ¯ã‚Šåˆ†ã‘çµæœä¸€è¦§</h3>
                            <button onClick={downloadRoster} className="bg-orange-500 hover:bg-orange-600 text-white text-sm px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition shadow-md">
                                <Icons.Download/> åç°¿ã‚’ä¿å­˜
                            </button>
                        </div>
                        <div className="max-h-80 overflow-y-auto custom-scrollbar">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-green-50 sticky top-0 text-xs text-green-700 uppercase"><tr><th className="p-3 pl-6">ã‚¯ãƒ©ã‚¹</th><th className="p-3">ãƒãƒ¼ãƒ </th><th className="p-3">æ°å</th><th className="p-3">æ€§åˆ¥</th><th className="p-3">é †ä½</th></tr></thead>
                                <tbody>
                                    {teamData.map((d,i)=><tr key={i} className="border-b hover:bg-green-50"><td className="p-3 pl-6">{d.classNum}</td><td className={`p-3 font-bold ${d.team==='èµ¤'?'text-red-500':'text-slate-500'}`}>{d.team}</td><td className="p-3 font-medium">{d.name}</td><td className="p-3">{d.gender}</td><td className="p-3">{d.rankInGroup}</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const FinalResultView = () => {
                const [tab, setTab] = useState('race');

                const downloadRaceData = () => {
                    const wb = XLSX.utils.book_new();
                    const groups = [...new Set(raceList.map(r => r.group))];
                    groups.forEach(grp => {
                        const grpRaces = raceList.filter(r => r.group === grp);
                        const raceNos = [...new Set(grpRaces.map(r => r.raceNo))].sort((a,b)=>a-b);
                        const sheetData = [];
                        raceNos.forEach(rNo => {
                            const runners = grpRaces.filter(r => r.raceNo === rNo).sort((a,b)=>a.lane - b.lane);
                            const row = { "ãƒ¬ãƒ¼ã‚¹": `ç¬¬${rNo}R` };
                            runners.forEach(r => { row[`ã‚³ãƒ¼ã‚¹${r.lane}`] = r.name; });
                            sheetData.push(row);
                        });
                        const ws = XLSX.utils.json_to_sheet(sheetData);
                        XLSX.utils.book_append_sheet(wb, ws, `${grp}_å¾’ç«¶èµ°`);
                    });
                    XLSX.writeFile(wb, "é‹å‹•ä¼š_å¾’ç«¶èµ°ãƒªã‚¹ãƒˆ.xlsx");
                };

                const downloadLineupData = () => {
                    const wb = XLSX.utils.book_new();
                    const groups = [...new Set(lineupList.map(l => l.groupKey))];
                    groups.forEach(grp => {
                        const members = lineupList.filter(l => l.groupKey === grp);
                        const sheetData = [];
                        const maxRow = Math.max(...members.map(m => m.row));
                        for(let r = 1; r <= maxRow; r++) {
                            const rowObj = {};
                            const rowMembers = members.filter(m => m.row === r);
                            rowMembers.forEach(m => { rowObj[`åˆ—${m.column}`] = m.name; });
                            sheetData.push(rowObj);
                        }
                        const ws = XLSX.utils.json_to_sheet(sheetData);
                        XLSX.utils.book_append_sheet(wb, ws, grp);
                    });
                    XLSX.writeFile(wb, "é‹å‹•ä¼š_èƒŒã®é †ãƒªã‚¹ãƒˆ.xlsx");
                };

                return (
                    <div className="bg-white rounded-xl shadow-lg border border-green-200 overflow-hidden">
                        <div className="flex border-b bg-green-50">
                            {raceEnabled && <button onClick={()=>setTab('race')} className={`flex-1 py-4 font-bold text-sm flex items-center justify-center gap-2 ${tab==='race'?'bg-white border-t-4 border-green-500 text-green-700':'text-green-600 hover:bg-green-100'}`}><Icons.Run/> å¾’ç«¶èµ°ãƒªã‚¹ãƒˆ</button>}
                            {lineupEnabled && <button onClick={()=>setTab('lineup')} className={`flex-1 py-4 font-bold text-sm flex items-center justify-center gap-2 ${tab==='lineup'?'bg-white border-t-4 border-green-500 text-green-700':'text-green-600 hover:bg-green-100'}`}><Icons.Users/> èƒŒã®é †ãƒªã‚¹ãƒˆ</button>}
                        </div>
                        
                        <div className="p-6 min-h-[300px] bg-white">
                            {tab === 'race' && raceEnabled && (
                                <div className="animate-fade-in space-y-8">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-green-800 text-lg">ğŸƒ å¾’ç«¶èµ°çµ„ã¿åˆ†ã‘</h3>
                                        <button onClick={downloadRaceData} className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-full shadow-lg flex items-center gap-2 transition transform hover:-translate-y-1">
                                            <Icons.Download/> èµ°é †ã‚’ä¿å­˜
                                        </button>
                                    </div>
                                    
                                    {[...new Set(raceList.map(r=>r.group))].map(grp => (
                                        <div key={grp} className="bg-white rounded-xl border border-green-200 shadow-sm overflow-hidden">
                                            <div className="bg-green-50 px-4 py-3 border-b border-green-200 font-bold text-green-800 flex items-center gap-2">
                                                <span className="w-2 h-6 bg-green-500 rounded-full"></span>
                                                {grp}
                                            </div>
                                            
                                            <div className="overflow-x-auto custom-scrollbar">
                                                <div className="p-4 min-w-max space-y-3">
                                                    {[...new Set(raceList.filter(r=>r.group===grp).map(r=>r.raceNo))].sort((a,b)=>a-b).map(rNo => (
                                                        <div key={rNo} className="flex items-start gap-4 p-2 hover:bg-slate-50 rounded-lg transition-colors">
                                                            <div className="w-24 shrink-0 pt-2">
                                                                <span className="bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full">
                                                                    ç¬¬{rNo}ãƒ¬ãƒ¼ã‚¹
                                                                </span>
                                                            </div>
                                                            <div className="flex gap-3">
                                                                {raceList.filter(r=>r.group===grp && r.raceNo===rNo).sort((a,b)=>a.lane-b.lane).map(r => (
                                                                    <div key={r.lane} className={`w-28 p-2 rounded border text-center shrink-0 shadow-sm ${r.team==='èµ¤'?'bg-red-50 border-red-200 text-red-700':'bg-white border-slate-200 text-slate-700'}`}>
                                                                        <div className="text-[10px] opacity-60 mb-1 font-bold">{r.lane}ã‚³ãƒ¼ã‚¹</div>
                                                                        <div className="font-bold text-sm truncate" title={r.name}>{r.name}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {tab === 'lineup' && lineupEnabled && (
                                <div className="animate-fade-in">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-green-800 text-lg">ğŸ§ èƒŒã®é †éšŠå½¢ (ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º)</h3>
                                        <button onClick={downloadLineupData} className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-full shadow-lg flex items-center gap-2 transition transform hover:-translate-y-1">
                                            <Icons.Download/> èƒŒã®é †ã‚’ä¿å­˜
                                        </button>
                                    </div>
                                    <div className="grid gap-6 md:grid-cols-2 max-h-96 overflow-y-auto custom-scrollbar p-1">
                                        {[...new Set(lineupList.map(l=>l.groupKey))].map(grp => (
                                            <div key={grp} className="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm">
                                                <h4 className="font-bold text-green-700 mb-3 flex items-center gap-2">
                                                    <span className={`w-2 h-6 rounded ${grp.includes('èµ¤')?'bg-red-500':'bg-white border border-slate-300'}`}></span>
                                                    {grp.replace('_', ' ')}
                                                </h4>
                                                <div className="grid gap-2" style={{ gridTemplateColumns: `repeat(${lineupColumns}, 1fr)` }}>
                                                    {/* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ— */}
                                                    {[...Array(lineupColumns)].map((_, i) => <div key={i} className="text-center text-xs text-green-600 font-bold">{i+1}åˆ—</div>)}
                                                    
                                                    {/* ãƒ‡ãƒ¼ã‚¿ */}
                                                    {lineupList.filter(l=>l.groupKey===grp).map((l, idx) => (
                                                        <div key={idx} className={`p-2 text-center rounded border text-sm font-bold truncate ${l.team==='èµ¤'?'bg-white text-red-600 border-red-200':'bg-white text-slate-700 border-slate-300'}`} style={{ gridColumn: l.column, gridRow: l.row + 1 }}>
                                                            {l.name}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const StepIndicator = () => {
                const steps = [
                    { n: 1, t: 'åŸºæœ¬' }, { n: 2, t: 'ãƒ«ãƒ¼ãƒ«' }, { n: 3, t: 'å…¥åŠ›' }, { n: 4, t: 'åç°¿' }, { n: 5, t: 'è¨­å®š' }, { n: 6, t: 'å®Œäº†' }
                ];
                return (
                    <div className="mb-8 px-4">
                        <div className="flex items-center justify-between relative max-w-4xl mx-auto">
                            <div className="absolute top-4 left-0 w-full h-1 bg-green-200 -z-10 rounded"></div>
                            <div className="absolute top-4 left-0 h-1 bg-green-500 -z-10 rounded transition-all duration-300" style={{ width: `${((step - 1) / 5) * 100}%` }}></div>
                            {steps.map(s => (
                                <div key={s.n} className="flex flex-col items-center gap-1 bg-f0fdf4 px-2 z-10">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold border-2 transition-all duration-300 ${step === s.n ? 'border-green-600 bg-white text-green-600 scale-125 shadow-md' : step > s.n ? 'border-green-500 bg-green-500 text-white' : 'border-green-200 bg-white text-green-300'}`}>{step > s.n ? <Icons.Check/> : s.n}</div>
                                    <span className={`text-[10px] font-bold ${step===s.n?'text-green-700':'text-green-300'}`}>{s.t}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto flex flex-col">
                    <header className="mb-8 text-center animate-fade-in">
                        <h1 className="text-3xl font-black text-green-800 mb-2 tracking-tight flex items-center justify-center gap-3">
                            <span className="text-4xl">ğŸƒ</span> é‹å‹•ä¼š çµ„ã¿åˆ†ã‘ãƒã‚¹ã‚¿ãƒ¼
                        </h1>
                        <p className="text-green-600 text-sm">å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã§ã®ã¿å‡¦ç†ã•ã‚Œã€å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</p>
                    </header>

                    <StepIndicator />

                    <div className="flex-grow animate-fade-in">
                        {/* STEP 1: åŸºæœ¬æ¡ä»¶ */}
                        {step === 1 && (
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-green-200 max-w-3xl mx-auto space-y-8">
                                <h2 className="text-xl font-bold text-green-700 border-b border-green-100 pb-4 flex items-center gap-2"><Icons.Settings/> åŸºæœ¬æ¡ä»¶ã‚’è¨­å®š</h2>
                                
                                <div className="space-y-6">
                                    {/* çµ„ã¿åˆ†ã‘å˜ä½ */}
                                    <div>
                                        <label className="block text-sm font-bold text-green-600 mb-3 uppercase tracking-wider">çµ„ã¿åˆ†ã‘å˜ä½</label>
                                        <div className="grid grid-cols-2 gap-4">
                                            <SelectionCard selected={grouping==='grade'} onClick={()=>setGrouping('grade')} icon={Icons.Grade} title="å­¦å¹´å…¨ä½“" desc="ã‚¯ãƒ©ã‚¹ã«é–¢ä¿‚ãªãå…¨ä½“ã§åˆ†ã‘ã¾ã™" />
                                            <SelectionCard selected={grouping==='class'} onClick={()=>setGrouping('class')} icon={Icons.Class} title="ã‚¯ãƒ©ã‚¹ã”ã¨" desc="å„ã‚¯ãƒ©ã‚¹å†…ã§å‡ç­‰ã«åˆ†ã‘ã¾ã™" />
                                        </div>
                                    </div>
                                    {/* ãƒ¢ãƒ¼ãƒ‰ */}
                                    <div>
                                        <label className="block text-sm font-bold text-green-600 mb-3 uppercase tracking-wider">ãƒ¢ãƒ¼ãƒ‰</label>
                                        <div className="grid grid-cols-2 gap-4">
                                            <SelectionCard selected={mode==='separate'} onClick={()=>setMode('separate')} icon={Icons.Separate} title="ç”·å¥³åˆ¥" desc="ç”·å¥³ãã‚Œãã‚Œã§é †ä½ã‚’ã¤ã‘ã¦åˆ†ã‘ã¾ã™" />
                                            <SelectionCard selected={mode==='mixed'} onClick={()=>setMode('mixed')} icon={Icons.Mixed} title="ç”·å¥³æ··åˆ" desc="æ€§åˆ¥ã«é–¢ä¿‚ãªãå…¨ä½“ã§åˆ†ã‘ã¾ã™" />
                                        </div>
                                    </div>
                                    {/* åŸºæº– */}
                                    <div>
                                        <label className="block text-sm font-bold text-green-600 mb-3 uppercase tracking-wider">ä¸¦ã³æ›¿ãˆåŸºæº–</label>
                                        <div className="grid grid-cols-2 gap-4">
                                            <SelectionCard selected={criteria==='time'} onClick={()=>setCriteria('time')} icon={Icons.Time} title="ã‚¿ã‚¤ãƒ é †" desc="é€Ÿã„é †ã«ä¸¦ã³æ›¿ãˆã¾ã™" />
                                            <SelectionCard selected={criteria==='height'} onClick={()=>setCriteria('height')} icon={Icons.Height} title="èƒŒã®é †" desc="ä½ã„é †ã«ä¸¦ã³æ›¿ãˆã¾ã™" />
                                        </div>
                                    </div>
                                </div>
                                <div className="text-right pt-4"><button onClick={()=>setStep(2)} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transition transform hover:-translate-y-1 flex items-center gap-2 ml-auto">æ¬¡ã¸ <Icons.ArrowRight/></button></div>
                            </div>
                        )}

                        {/* STEP 2: ãƒ«ãƒ¼ãƒ« */}
                        {step === 2 && (
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-green-200 max-w-3xl mx-auto space-y-8">
                                <h2 className="text-xl font-bold text-green-700 border-b border-green-100 pb-4 flex items-center gap-2"><Icons.Sort/> ãƒãƒ¼ãƒ åˆ†ã‘ãƒ«ãƒ¼ãƒ«ã®é¸æŠ</h2>
                                <div className="space-y-6">
                                    <div>
                                        <label className="block font-bold text-green-700 mb-3">{mode==='separate'?'ç”·å­':'å…¨ä½“'}ã®ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
                                        <div className="grid md:grid-cols-2 gap-3">
                                            {PATTERNS.map(p=><SelectionCard key={p.id} selected={ruleBoy===p.id} onClick={()=>setRuleBoy(p.id)} icon={Icons.Check} title={p.name} desc={p.sub} />)}
                                        </div>
                                        <div className="mt-2 text-xs text-green-600 bg-green-50 p-2 rounded text-center">{PATTERNS.find(p=>p.id===ruleBoy)?.desc}</div>
                                    </div>
                                    {mode==='separate' && (
                                        <div>
                                            <label className="block font-bold text-green-700 mb-3 text-pink-600">å¥³å­ã®ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
                                            <div className="grid md:grid-cols-2 gap-3">
                                                {PATTERNS.map(p=><SelectionCard key={p.id} selected={ruleGirl===p.id} onClick={()=>setRuleGirl(p.id)} icon={Icons.Check} title={p.name} desc={p.sub} color="pink" />)}
                                            </div>
                                            <div className="mt-2 text-xs text-green-600 bg-green-50 p-2 rounded text-center">{PATTERNS.find(p=>p.id===ruleGirl)?.desc}</div>
                                        </div>
                                    )}
                                    <div className="flex justify-between pt-4">
                                        <button onClick={()=>setStep(1)} className="text-green-600 font-bold px-6 py-3 rounded-full hover:bg-green-50 flex items-center gap-2"><Icons.ArrowLeft/> æˆ»ã‚‹</button>
                                        <button onClick={()=>setStep(3)} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transition transform hover:-translate-y-1 flex items-center gap-2">æ¬¡ã¸ <Icons.ArrowRight/></button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* STEP 3: å…¥åŠ› */}
                        {step === 3 && (
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-green-200 max-w-4xl mx-auto space-y-6">
                                <h2 className="text-xl font-bold text-green-700 border-b border-green-100 pb-4 flex items-center gap-2"><Icons.User/> ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›</h2>
                                <div className="flex flex-wrap gap-4 items-center justify-between mb-4 bg-green-50 p-4 rounded-lg border border-green-100">
                                    <div className="text-sm text-green-900 flex-1 min-w-[200px]">
                                        <p className="font-bold mb-1">ã€Excelã‹ã‚‰ã®åˆ—ã‚³ãƒ”ãƒ¼é †åºã€‘</p>
                                        <p className="font-mono text-xs md:text-sm whitespace-nowrap overflow-x-auto">A:æ°å | B:ã‚¯ãƒ©ã‚¹ | C:æ€§åˆ¥ | D:ã‚¿ã‚¤ãƒ  | E:èº«é•· | <span className="text-red-600 font-bold">F:ãƒãƒ¼ãƒ æŒ‡å®š</span></p>
                                        <p className="text-xs text-red-500 mt-1 font-bold">â€»Fåˆ—ã«ã€èµ¤ã€ã€ç™½ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ã€è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ã•ã‚Œãšã«ãã®ãƒãƒ¼ãƒ ã«ãªã‚Šã¾ã™ã€‚</p>
                                        <p className="text-xs text-slate-500 mt-1">â€»å…¥åŠ›æ¬„ã§åˆ—ãŒã‚ºãƒ¬ã¦è¦‹ãˆã¦ã‚‚ã€ä¸‹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ãŒåˆã£ã¦ã„ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setRawInput(SAMPLE_DATA)} className="text-xs bg-white text-green-600 border border-green-200 px-3 py-2 rounded shadow-sm hover:bg-green-50 font-bold">ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›</button>
                                        <button onClick={downloadTemplate} className="bg-orange-500 hover:bg-orange-600 text-white text-xs px-3 py-2 rounded shadow-sm flex items-center gap-1 font-bold"><Icons.Download/> ğŸ“„ å…¥åŠ›ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                                    </div>
                                </div>
                                <div className="border-2 border-green-200 rounded-lg overflow-hidden focus-within:border-green-400 transition-colors">
                                    <textarea className="w-full h-48 p-4 data-input focus:outline-none" value={rawInput} onChange={(e)=>setRawInput(e.target.value)} placeholder="Excelã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„..."></textarea>
                                </div>
                                <PreviewTable inputData={rawInput} />
                                <div className="flex justify-between pt-4">
                                    <button onClick={()=>setStep(2)} className="text-green-600 font-bold px-6 py-3 rounded-full hover:bg-green-50 flex items-center gap-2"><Icons.ArrowLeft/> æˆ»ã‚‹</button>
                                    <button onClick={requestAssignTeams} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transition transform hover:-translate-y-1 flex items-center gap-2">çµ„ã¿åˆ†ã‘å®Ÿè¡Œ <Icons.ArrowRight/></button>
                                </div>
                            </div>
                        )}

                        {/* STEP 4: ç¢ºèª */}
                        {step === 4 && (
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-green-200 max-w-4xl mx-auto space-y-6">
                                <h2 className="text-xl font-bold text-green-700 border-b border-green-100 pb-4 flex items-center gap-2"><Icons.Check/> çµæœç¢ºèª</h2>
                                <div className="bg-green-50 p-4 rounded-lg text-green-800 text-sm border border-green-100 flex items-center gap-2 font-bold">
                                    <Icons.Check/> ãƒãƒ¼ãƒ åˆ†ã‘ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã€å•é¡Œãªã‘ã‚Œã°å‡ºåŠ›è¨­å®šã«é€²ã‚“ã§ãã ã•ã„ã€‚
                                </div>
                                <ResultTableStep4 />
                                <div className="flex justify-between pt-4">
                                    <button onClick={()=>setStep(3)} className="text-green-600 font-bold px-6 py-3 rounded-full hover:bg-green-50 flex items-center gap-2"><Icons.ArrowLeft/> æˆ»ã‚‹</button>
                                    <button onClick={()=>setStep(5)} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transition transform hover:-translate-y-1 flex items-center gap-2">æ¬¡ã¸(å‡ºåŠ›è¨­å®š) <Icons.ArrowRight/></button>
                                </div>
                            </div>
                        )}

                        {/* STEP 5: å‡ºåŠ›è¨­å®š */}
                        {step === 5 && (
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-green-200 max-w-3xl mx-auto space-y-8">
                                <h2 className="text-xl font-bold text-green-700 border-b border-green-100 pb-4 flex items-center gap-2"><Icons.Settings/> å‡ºåŠ›è©³ç´°è¨­å®š</h2>
                                
                                {/* å¾’ç«¶èµ°è¨­å®š */}
                                <div className="border border-green-200 p-6 rounded-xl bg-green-50 hover:border-green-300 transition-colors">
                                    <label className="font-bold flex items-center gap-3 cursor-pointer mb-4 text-lg text-green-800 border-b border-green-200 pb-2">
                                        <input type="checkbox" checked={raceEnabled} onChange={(e)=>setRaceEnabled(e.target.checked)} className="w-6 h-6 accent-green-600"/>
                                        ğŸƒ å¾’ç«¶èµ°(èµ°é †)ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                                    </label>
                                    {raceEnabled && (
                                        <div className="ml-2 space-y-6 animate-fade-in">
                                            {/* ãƒ¢ãƒ¼ãƒ‰é¸æŠ */}
                                            <div>
                                                <label className="block text-xs font-bold text-green-600 mb-2 uppercase">ãƒ¢ãƒ¼ãƒ‰</label>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <SelectionCard selected={raceMode==='separate'} onClick={()=>setRaceMode('separate')} icon={Icons.Separate} title="ç”·å¥³åˆ¥" desc="ç”·å¥³åˆ†ã‘ã¦èµ°ã‚Šã¾ã™" />
                                                    <SelectionCard selected={raceMode==='mixed'} onClick={()=>setRaceMode('mixed')} icon={Icons.Mixed} title="ç”·å¥³æ··åˆ" desc="æ··åˆã§èµ°ã‚Šã¾ã™" />
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3 bg-white p-3 rounded border border-green-100">
                                                <span className="font-bold text-green-700">1ãƒ¬ãƒ¼ã‚¹ã‚ãŸã‚Šã®äººæ•°:</span>
                                                <input type="number" min="2" max="10" value={runnersPerRace} onChange={(e)=>setRunnersPerRace(Number(e.target.value))} className="border-2 border-green-200 p-2 w-20 text-center rounded-lg font-bold text-lg focus:border-green-500 focus:outline-none"/>
                                                <span className="font-bold text-green-700">äºº</span>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* èƒŒã®é †è¨­å®š */}
                                <div className="border border-green-200 p-6 rounded-xl bg-green-50 hover:border-green-300 transition-colors">
                                    <label className="font-bold flex items-center gap-3 cursor-pointer mb-4 text-lg text-green-800 border-b border-green-200 pb-2">
                                        <input type="checkbox" checked={lineupEnabled} onChange={(e)=>setLineupEnabled(e.target.checked)} className="w-6 h-6 accent-green-600"/>
                                        ğŸ§ èƒŒã®é †(æ•´åˆ—)ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                                    </label>
                                    {lineupEnabled && (
                                        <div className="ml-2 space-y-6 animate-fade-in">
                                            {/* å˜ä½ */}
                                            <div>
                                                <label className="block text-xs font-bold text-green-600 mb-2 uppercase">â‘  ä¸¦ã³é †ã®ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½</label>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <SelectionCard selected={lineupGrouping==='class'} onClick={()=>setLineupGrouping('class')} icon={Icons.Class} title="ã‚¯ãƒ©ã‚¹ã”ã¨" desc="1çµ„èµ¤, 1çµ„ç™½..." />
                                                    <SelectionCard selected={lineupGrouping==='grade'} onClick={()=>setLineupGrouping('grade')} icon={Icons.Grade} title="å­¦å¹´é€šã—" desc="èµ¤çµ„å…¨ä½“, ç™½çµ„å…¨ä½“" />
                                                </div>
                                            </div>
                                            {/* ãƒ¢ãƒ¼ãƒ‰ */}
                                            <div>
                                                <label className="block text-xs font-bold text-green-600 mb-2 uppercase">â‘¡ ä¸¦ã³æ–¹</label>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <SelectionCard selected={lineupMode==='separate'} onClick={()=>setLineupMode('separate')} icon={Icons.Separate} title="ç”·å¥³åˆ¥åˆ—" desc="ç”·å­åˆ—ãƒ»å¥³å­åˆ—ã«åˆ†ã‘ã¾ã™" />
                                                    <SelectionCard selected={lineupMode==='mixed'} onClick={()=>setLineupMode('mixed')} icon={Icons.Mixed} title="ç”·å¥³æ··åˆåˆ—" desc="æ··åˆã§ä¸¦ã³ã¾ã™" />
                                                </div>
                                            </div>
                                            <div className="bg-white p-3 rounded border border-green-100">
                                                <div className="flex items-center gap-3">
                                                    <span className="font-bold text-green-700">â‘¢ å…¨ä½“ã®åˆ—æ•° (æŠ˜ã‚Šè¿”ã—):</span>
                                                    <input type="number" min="1" max="20" value={lineupColumns} onChange={(e)=>setLineupColumns(Number(e.target.value))} className="border-2 border-green-200 p-2 w-20 text-center rounded-lg font-bold text-lg focus:border-green-500 focus:outline-none"/>
                                                    <span className="font-bold text-green-700">åˆ—</span>
                                                </div>
                                                {lineupMode==='separate' && (
                                                    <p className="text-xs text-green-600 mt-2 font-bold">
                                                        ğŸ’¡ ç”·å¥³åˆ¥ã®å ´åˆ: ç”·å­ {Math.floor(lineupColumns/2) || 1}åˆ— ï¼‹ å¥³å­ {lineupColumns - (Math.floor(lineupColumns/2) || 1)}åˆ— ï¼ åˆè¨ˆ {lineupColumns}åˆ— ã«ãªã‚Šã¾ã™ã€‚
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="flex justify-between pt-4">
                                    <button onClick={()=>setStep(4)} className="text-green-600 font-bold px-6 py-3 rounded-full hover:bg-green-50 flex items-center gap-2"><Icons.ArrowLeft/> æˆ»ã‚‹</button>
                                    <button onClick={generateFinalOutput} className="bg-gradient-to-r from-green-600 to-teal-600 text-white font-bold py-3 px-12 rounded-full shadow-lg hover:from-green-700 hover:to-teal-700 transform hover:-translate-y-1 transition flex items-center gap-2">
                                        <Icons.Check/> æœ€çµ‚ãƒªã‚¹ãƒˆä½œæˆ
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* STEP 6: å®Œäº† */}
                        {step === 6 && (
                            <div className="bg-white p-8 rounded-2xl shadow-xl border border-green-200 max-w-6xl mx-auto space-y-6 animate-fade-in">
                                <h2 className="text-2xl font-black text-green-800 border-b border-green-100 pb-4 flex items-center gap-2 text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-teal-600">
                                    ğŸ‰ ä½œæˆå®Œäº†
                                </h2>
                                <FinalResultView />
                                <div className="text-center mt-8">
                                    <button onClick={()=>setStep(5)} className="text-slate-500 border-2 border-slate-200 px-6 py-3 rounded-full hover:bg-slate-50 hover:text-slate-700 font-bold transition">è¨­å®šã‚’å¤‰æ›´ã—ã¦å†ä½œæˆ</button>
                                </div>
                            </div>
                        )}
                    </div>
                    {showPasswordModal && <PasswordModal 
                        show={showPasswordModal}
                        onClose={() => setShowPasswordModal(false)}
                        onSuccess={onPasswordSuccess}
                    />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
